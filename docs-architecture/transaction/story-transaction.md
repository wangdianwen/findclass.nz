---
title: Story - Transaction Module
category: integration-test
created: 2026-01-26
author: linus-torvalds
version: 1.0
status: draft
module: transaction
filename: story-transaction.md
---

# Story - 交易模块集成测试

> **模块**: transaction | **测试类型**: integration | **路径**: `tests/integration/transaction/`

> **测试原则**: 集成测试(20%) 验证端到端用户流程，单元测试(80%) 覆盖所有API逻辑

---

## US16: 课程预约流程

### 用户故事

```
作为 家长
我希望 在线预约课程试听
以便 安排孩子的学习时间并完成报名
```

### 测试用例

#### Happy Path - 完整预约流程

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-HP | 完整预约流程 | 用户已登录，有可用时段 | 选择课程→选择时段→填写信息→确认预约 | 预约创建成功，状态pending |
| TC02-HP | 预约即时确认课程 | 用户已登录，有即时确认课程 | 选择时段→确认 | 预约自动确认 |
| TC03-HP | 查看我的预约列表 | 已有预约 | 查询预约列表 | 返回分页数据 |
| TC04-HP | 查看预约详情 | 已有预约 | 查询详情 | 返回完整预约信息 |
| TC05-HP | 取消待确认预约 | 预约待确认 | 取消预约 | 预约取消成功，时段释放 |
| TC06-HP | 教师确认预约 | 预约待确认 | 教师确认 | 预约状态变confirmed |
| TC07-HP | 预约时间段展示 | 用户浏览课程 | 查看可用时段 | 显示可用/已约满状态 |
| TC08-HP | 预约成功发送通知 | 预约创建成功 | - | 发送确认邮件/SMS |

#### Failed Cases - 预约失败场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-FC | 未登录预约 | 用户未登录 | 选择时段→确认 | 引导登录页面 |
| TC02-FC | 预约已满时段 | 用户已登录 | 选择已约满时段 | 提示已约满 |
| TC03-FC | 预约已锁定时段 | 用户已登录 | 选择锁定中时段 | 提示时段锁定中 |
| TC04-FC | 预约过期时段 | 用户已登录 | 选择过期日期时段 | 提示时段不可用 |
| TC05-FC | 预约不存在课程 | 用户已登录 | 预约不存在的课程ID | 返回404 |
| TC06-FC | 越权取消他人预约 | 其他用户有预约 | 尝试取消 | 返回403 |
| TC07-FC | 取消已确认预约 | 预约已确认 | 取消预约 | 提示不可取消或需退款 |
| TC08-FC | 取消已完成的预约 | 预约已完成 | 取消预约 | 提示已完成不可取消 |
| TC09-FC | 填写必填信息缺失 | 用户已选择时段 | 提交空白表单 | 提示必填字段 |
| TC10-FC | 联系方式格式错误 | 用户填写信息 | 输入无效手机号 | 提示格式错误 |

#### Edge Cases - 边界场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-EC | 并发预约同一时段 | 两个用户同时预约 | 同时提交预约 | 一个成功，一个失败 |
| TC02-EC | 预约特殊日期 | 节假日时段 | 预约成功 | 正确处理 |
| TC03-EC | 长时间预约 | 预约1个月后时段 | 预约成功 | 正确创建 |
| TC04-EC | 多次取消同一预约 | 预约已取消 | 再次取消 | 提示已取消 |
| TC05-EC | 预约列表为空 | 用户无预约 | 查询列表 | 返回空列表 |
| TC06-EC | 预约列表分页 | 用户有20+预约 | 分页查询 | 返回正确分页 |
| TC07-EC | 取消后时段释放 | 预约取消成功 | 查看时段状态 | 时段变available |
| TC08-EC | 预约课程被下架 | 预约创建后课程下架 | 查看预约 | 预约仍有效或引导处理 |
| TC09-EC | 教师账号被禁用 | 预约创建后教师禁用 | 查看预约 | 提示并引导处理 |
| TC10-EC | 网络中断恢复 | 预约提交中断 | 重新提交 | 预约创建成功 |

---

## US17: 支付流程

### 用户故事

```
作为 家长
我希望 为预约的课程支付费用
以便 完成报名流程
```

### 测试用例

#### Happy Path - 支付流程

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-HP | 创建支付订单 | 预约待支付 | 创建订单 | 订单创建成功 |
| TC02-HP | 支付成功回调 | 订单待支付 | 模拟支付回调 | 订单变paid，预约更新 |
| TC03-HP | 查看支付记录 | 有支付记录 | 查询记录 | 返回历史记录 |
| TC04-HP | 查看支付详情 | 有支付记录 | 查询详情 | 返回完整信息 |
| TC05-HP | 支付订单过期 | 订单未支付过期 | - | 订单变expired |
| TC06-HP | 使用优惠券支付 | 支持优惠券 | 应用优惠券 | 优惠抵扣成功 |

#### Failed Cases - 支付失败场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-FC | 支付不存在订单 | - | 支付不存在的订单 | 返回404 |
| TC02-FC | 重复支付已支付订单 | 订单已支付 | 再次支付 | 提示已支付 |
| TC03-FC | 支付已过期订单 | 订单已过期 | 支付 | 提示订单已过期 |
| TC04-FC | 支付金额不匹配 | 订单待支付 | 修改金额支付 | 提示金额不匹配 |
| TC05-FC | 优惠券已过期 | 订单待支付 | 使用过期优惠券 | 提示优惠券无效 |
| TC06-FC | 优惠券已达使用上限 | 订单待支付 | 使用达上限优惠券 | 提示已达上限 |
| TC07-FC | 支付方式不支持 | - | 选择不支持方式 | 提示方式不可用 |
| TC08-FC | 银行卡余额不足 | - | 支付 | 提示余额不足 |

#### Edge Cases - 边界场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-EC | 并发支付同一订单 | 两个请求支付同一订单 | 同时支付 | 一个成功，一个提示已支付 |
| TC02-EC | 大额支付 | 高价课程 | 支付成功 | 正常处理 |
| TC03-EC | 支付回调延迟 | 支付成功回调延迟 | 查询订单状态 | 最终状态一致 |
| TC04-EC | 优惠券金额大于订单 | 优惠券金额>订单金额 | 使用优惠券 | 抵扣后需支付0或提示 |
| TC05-EC | 支付中断恢复 | 支付中断 | 重新支付 | 订单状态恢复 |

---

## US18: 退款流程

### 用户故事

```
作为 家长
我希望 申请退款
以便 取消课程并获得退款
```

### 测试用例

#### Happy Path - 退款流程

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-HP | 正常退款申请 | 预约已支付，可退款 | 申请退款 | 退款申请成功 |
| TC02-HP | 管理员审核退款 | 退款申请待审核 | 审核通过 | 退款成功，金额退还 |
| TC03-HP | 退款到账 | 退款成功 | 查看账户 | 金额已退还 |
| TC04-HP | 查看退款记录 | 有退款记录 | 查询记录 | 返回历史记录 |
| TC05-HP | 退款拒绝 | 退款申请待审核 | 审核拒绝 | 退款拒绝，恢复预约状态 |

#### Failed Cases - 退款失败场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-FC | 退款已退款订单 | 订单已退款 | 再次申请 | 提示已退款 |
| TC02-FC | 退款未支付订单 | 订单未支付 | 申请退款 | 提示未支付不可退款 |
| TC03-FC | 退款过期课程 | 课程已完成 | 申请退款 | 提示不可退款 |
| TC04-FC | 越权退款 | 其他用户订单 | 申请退款 | 返回403 |
| TC05-FC | 退款金额不匹配 | 退款申请 | 输入错误金额 | 提示金额不匹配 |
| TC06-FC | 管理员越权审核 | 非管理员 | 审核退款 | 返回403 |

#### Edge Cases - 边界场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-EC | 部分退款 | 支持部分退款 | 退款部分金额 | 部分退款成功 |
| TC02-EC | 退款政策边界 | 开课前X小时 | 根据政策判断 | 正确处理 |
| TC03-EC | 并发退款申请 | 同一订单多个申请 | 多次申请 | 只有一个成功 |
| TC04-EC | 退款到账延迟 | 退款成功 | 立即查询 | 显示处理中 |

---

## US19: 套餐管理

### 用户故事

```
作为 家长
我希望 购买和使用课程套餐
以便 获得优惠并管理课程包
```

### 测试用例

#### Happy Path - 套餐流程

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-HP | 购买套餐 | 用户已登录 | 购买套餐 | 购买成功，获得套餐 |
| TC02-HP | 查看我的套餐 | 已有套餐 | 查询套餐列表 | 返回套餐信息 |
| TC03-HP | 使用套餐预约 | 已有套餐，预约课程 | 预约时使用套餐 | 套餐课时扣减 |
| TC04-HP | 套餐余额不足 | 套餐余1课时，预约2课时 | 使用套餐 | 提示余额不足 |
| TC05-HP | 套餐即将过期 | 套餐即将过期 | 查看套餐 | 显示即将过期提醒 |

#### Failed Cases - 套餐失败场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-FC | 购买不存在的套餐 | - | 购买 | 返回404 |
| TC02-FC | 套餐已过期 | 套餐已过期 | 使用套餐 | 提示已过期 |
| TC03-FC | 使用他人套餐 | 其他用户套餐 | 使用 | 提示无权限 |
| TC04-FC | 套餐余额为零 | 套餐已用完 | 使用套餐 | 提示无余额 |
| TC05-FC | 越权转让套餐 | 套餐不可转让 | 转让 | 提示不支持 |

#### Edge Cases - 边界场景

| 用例ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC01-EC | 套餐余额精确用完 | 套餐余1课时 | 使用1课时预约 | 预约成功，套餐清零 |
| TC02-EC | 套餐跨年有效期 | 套餐有效期至明年 | 使用预约 | 正常处理 |
| TC03-EC | 大量套餐管理 | 用户有10+套餐 | 查询列表 | 返回正确分页 |
| TC04-EC | 套餐组合使用 | 有多个套餐 | 优先使用规则 | 按规则扣减 |

---

## 测试数据

```typescript
// 测试数据
const testBookings = [
  {
    id: 'booking-001',
    studentId: 'user-001',
    courseId: 'course-001',
    teacherId: 'teacher-001',
    slotId: 'slot-001',
    bookingDate: '2026-02-01',
    startTime: '14:00',
    endTime: '15:00',
    status: 'pending',
    paymentStatus: 'unpaid',
    price: 100,
  },
];

const testPayments = [
  {
    id: 'payment-001',
    bookingId: 'booking-001',
    userId: 'user-001',
    amount: 100,
    status: 'paid',
    paymentMethod: 'credit_card',
  },
];

const testPackages = [
  {
    id: 'package-001',
    userId: 'user-001',
    courseId: 'course-001',
    totalHours: 10,
    usedHours: 2,
    expiresAt: '2026-12-31',
    status: 'active',
  },
];
```

---

## 相关文档

| 文档 | 路径 |
|------|------|
| 预约技术架构 | ../transaction/tech-booking.md |
| 支付技术架构 | ../transaction/tech-payments.md |
| 退款技术架构 | ../transaction/tech-refunds.md |
| 套餐技术架构 | ../transaction/tech-packages.md |
| 预约产品设计 | ../../05-product-design/transaction/booking.md |

---

**文档路径**: `/Users/dianwenwang/Project/idea/06-tech-architecture/transaction/transaction-stories.md`
